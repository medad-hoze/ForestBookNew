<!DOCTYPE html>
<html dir="rtl">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>ספר יער - מערכת ניהול יערות</title>
    <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css">
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Arial, sans-serif;
            background: #f5f5f5;
            overflow-x: hidden;
            position: relative;
        }
        
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('LOGO.jpg');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
            opacity: 0.35;
            z-index: -1;
            pointer-events: none;
        }
        
        .header {
            background: white;
            padding: 15px 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            display: flex;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
            position: relative;
            z-index: 10;
        }
        
        .logo svg {
            width: 50px;
            height: 50px;
        }
        
        .logo img{
            height:48px;
            width:auto;
            border-radius:8px;
            box-shadow:0 2px 8px rgba(0,0,0,.08);
        }
        
        .title {
            font-size: 24px;
            font-weight: bold;
            color: #2d6a4f;
        }
        
        .date-filters {
            display: flex;
            gap: 15px;
            flex: 1;
            flex-wrap: wrap;
            align-items: center;
        }
        
        .date-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .date-group label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }
        
        .date-group select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 8px;
            background: white;
            font-size: 14px;
            min-width: 120px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .date-group select:hover {
            border-color: #40916c;
        }
        
        .date-group select:focus {
            outline: none;
            border-color: #40916c;
            box-shadow: 0 0 0 3px rgba(64, 145, 108, 0.1);
        }
        
        .event-types {
            background: white;
            padding: 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            overflow: hidden;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            position: relative;
        }
        
        .event-type-card {
            min-width: 150px;
            padding: 15px 20px;
            background: #52b788;
            color: white;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .event-type-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.15);
        }
        
        .event-type-card.active {
            background: #2d6a4f;
            transform: scale(1.05);
        }
        
        .event-count {
            font-size: 28px;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .event-type-name {
            font-size: 14px;
            opacity: 0.9;
        }
        
        .scroll-button {
            background: #f0f0f0;
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }
        
        .scroll-button:hover {
            background: #e0e0e0;
        }
        
        .content-wrapper {
            direction: ltr;

            display: flex;
            height: calc(100vh - 270px);
            position: relative;
            gap: 0;
        }
        
        .resize-divider {
            width: 40px;
            background: #f0f0f0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            transition: background 0.3s ease;
        }
        
        .resize-divider:hover {
            background: #e0e0e0;
        }
        
        .resize-button {
            background: #2d6a4f;
            color: white;
            border: none;
            width: 30px;
            height: 60px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .resize-button:hover {
            background: #1f4d36;
            transform: scaleY(1.1);
        }

        .resize-divider { width: 48px; }
        .resize-stack { display: flex; flex-direction: column; gap: 8px; align-items: center; }
        .resize-button { width: 36px; height: 36px; border-radius: 8px; }

        .map-section {
            flex: 2;
            position: relative;
            transition: flex 0.5s ease;
        }
        
        .map-section.expanded {
            flex: 1;
        }
        
        .map-section.collapsed {
            flex: 0;
            display: none;
        }
        
        .map-container {
            height: 100%;
            position: relative;
        }
        
        .table-section {
            flex: 1;
            background: white;
            overflow-y: auto;
            transition: flex 0.5s ease;
            border-right: none; 
            border-left: 1px solid #ddd;
        }
        
        .table-section.expanded {
            flex: 1;
        }
        
        .table-section.collapsed {
            flex: 0;
            display: none;
        }
        
        .legend-control {
            position: absolute;
            top: 15px;
            left: 15px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.15);
            z-index: 999;
            min-width: 250px;
            overflow: hidden;
        }
        
        .legend-header {
            background: #2d6a4f;
            color: white;
            padding: 12px 15px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .legend-toggle {
            font-size: 20px;
            transition: transform 0.3s ease;
        }
        
        .legend-toggle.collapsed {
            transform: rotate(180deg);
        }
        
        .legend-content {
            padding: 15px;
            max-height: 400px;
            overflow-y: auto;
            transition: max-height 0.3s ease;
        }
        
        .legend-content.collapsed {
            max-height: 0;
            padding: 0 15px;
        }
        
        .layer-control {
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid #e0e0e0;
        }
        
        .layer-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            cursor: pointer;
        }
        
        .layer-toggle input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .layer-toggle label {
            cursor: pointer;
            font-weight: 500;
            color: #333;
        }
        
        .legend-section {
            margin-bottom: 15px;
        }
        
        .legend-section h4 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #666;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 8px;
        }
        
        .legend-symbol {
            width: 30px;
            height: 30px;
            border-radius: 50%;
            border: 2px solid white;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
        }
        
        .legend-symbol.forest {
            width: 30px;
            height: 20px;
            border-radius: 4px;
            background: rgba(50, 150, 50, 0.3);
            border: 2px solid rgba(0, 100, 0, 0.8);
        }
        
        .legend-label {
            font-size: 13px;
            color: #555;
        }
        
        /* Info panel styles */
        .info-panel {
            direction: rtl;

            padding: 20px;
            height: 100%;
            overflow-y: auto;
        }
        
        .info-panel h3 {
            margin: 0 0 15px 0;
            font-size: 20px;
            font-weight: 600;
            color: #1b4332;
        }
        
        .summary-info {
            background: #f8f9fa;
            padding: 10px 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 14px;
            color: #495057;
            line-height: 1.6;
        }
        
        .info-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        
        .info-table th {
            padding: 10px;
            text-align: right;
            font-weight: 600;
            color: #495057;
            background: #f8f9fa;
            border-bottom: 2px solid #dee2e6;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        
        .info-table td {
            padding: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .info-table tr:hover {
            background: #f0f8f4;
        }
        
        .clickable-row {
            cursor: pointer;
            transition: background 0.2s ease;
        }
        
        .clickable-row:hover {
            background: #e8f5e9 !important;
        }
        
        .highlight-number {
            font-weight: bold;
            color: #2d6a4f;
        }
        
        .time-slider-container {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: white;
            padding: 15px 20px;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
            z-index: 50;
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .time-slider-label {
            font-weight: 600;
            color: #2d6a4f;
            min-width: 100px;
        }
        
        .time-slider-dates {
            font-size: 14px;
            color: #666;
            min-width: 200px;
            text-align: center;
        }
        
        .esri-time-slider {
            flex: 1;
        }
        
        .loading {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 30px 50px;
            border-radius: 12px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            font-size: 18px;
            z-index: 1000;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .loading::before {
            content: '';
            width: 30px;
            height: 30px;
            border: 3px solid #f0f0f0;
            border-top-color: #40916c;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .error-message {
            position: fixed;
            top: 20px;
            right: 20px;
            background: #dc3545;
            color: white;
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
            display: none;
            z-index: 1000;
            animation: slideIn 0.3s ease;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
.year-range {
  margin-inline-start: 120px;   
  padding-inline-start: 16px;    
  border-inline-start: 1px solid #e6e6e6; 
  display: flex;
  gap: 10px;
  align-items: end;
}

.year-range .date-group select {
  min-width: 110px;
}
    </style>
</head>
<body>
    <div class="header">
        <div class="logo">
            <svg viewBox="0 0 100 100">
                <image href="LOGO_KKL.jpg" x="5" y="5" height="90" width="90" />
            </svg>
            <span class="title">ספר יער</span>
        </div>


        <div class="date-filters">
            <div class="date-group">
                <label>מרחב</label>
                <select id="DistrictName">
                    <option value="">הכל</option>
                </select>
            </div>


            <div class="date-group">
                <label>אזור</label>
                <select id="region">
                    <option value="">הכל</option>
                </select>
            </div>
            <div class="date-group">
                <label>גוש</label>
                <select id="gush">
                    <option value="">הכל</option>
                </select>
            </div>
            <div class="date-group">
                <label>יער</label>
                <select id="forest">
                    <option value="">הכל</option>
                </select>
            </div>
            <div class="date-group">
                <label>חלקה</label>
                <select id="parcel">
                    <option value="">הכל</option>
                </select>
            </div>
            <div class="date-group">
                <label>עומד</label>
                <select id="stand">
                    <option value="">הכל</option>
                </select>
            </div>
            <div class="year-range">
  <div class="date-group">
    <label>מ-שנה</label>
    <select id="yearFrom">
      <option value="">מההתחלה</option>
    </select>
  </div>
  <div class="date-group">
    <label>עד שנה</label>
    <select id="yearTo">
      <option value="">עד הסוף</option>
    </select>
  </div>
</div>
        </div>
    </div>
    
    <div class="event-types">
        <button class="scroll-button" onclick="scrollEvents(-1)">‹</button>
        <div id="eventTypesContainer" style="display: flex; gap: 15px; overflow: hidden; scroll-behavior: smooth;">
            <!-- Event type cards -->
        </div>
        <button class="scroll-button" onclick="scrollEvents(1)">›</button>
    </div>
    
    <div class="content-wrapper">
        <div class="map-section" id="mapSection">
            <div id="mapView" class="map-container">
                <div class="legend-control">
                    <div class="legend-header" onclick="toggleLegend()">
                        <span>מקרא ושכבות</span>
                        <span class="legend-toggle" id="legendToggle">▼</span>
                    </div>
                    <div class="legend-content" id="legendContent">
                        <div class="layer-control">
                            <div class="layer-toggle">
                                <input type="checkbox" id="forestLayerToggle" checked>
                                <label for="forestLayerToggle">שכבת יערות</label>
                            </div>
                            <div class="layer-toggle">
                                <input type="checkbox" id="eventsLayerToggle" checked>
                                <label for="eventsLayerToggle">שכבת אירועים</label>
                            </div>
                        </div>
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px;">
                            <div class="legend-section">
                                <h4>סוגי כיסוי יער</h4>
                                <div class="legend-item">
                                    <div class="legend-symbol" style="background: rgba(0, 77, 0, 0.4); border: 2px solid rgba(0, 51, 0, 0.8);"></div>
                                    <span class="legend-label">מעורב עצי מחט</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-symbol" style="background: rgba(0, 102, 0, 0.4); border: 2px solid rgba(0, 77, 0, 0.8);"></div>
                                    <span class="legend-label">אורן ברוטיה</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-symbol" style="background: rgba(0, 128, 0, 0.4); border: 2px solid rgba(0, 102, 0, 0.8);"></div>
                                    <span class="legend-label">אורן ירושלים</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-symbol" style="background: rgba(0, 153, 0, 0.4); border: 2px solid rgba(0, 128, 0, 0.8);"></div>
                                    <span class="legend-label">אורן גלעין</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-symbol" style="background: rgba(46, 125, 50, 0.4); border: 2px solid rgba(27, 94, 32, 0.8);"></div>
                                    <span class="legend-label">ברוש מצוי</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-symbol" style="background: rgba(34, 139, 34, 0.4); border: 2px solid rgba(0, 100, 0, 0.8);"></div>
                                    <span class="legend-label">רחבי עלים</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-symbol" style="background: rgba(144, 238, 144, 0.4); border: 2px solid rgba(0, 128, 0, 0.8);"></div>
                                    <span class="legend-label">מעורב רחבי עלים</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-symbol" style="background: rgba(60, 179, 113, 0.4); border: 2px solid rgba(46, 125, 50, 0.8);"></div>
                                    <span class="legend-label">מעורב עצי מחט - רחבי עלים</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-symbol" style="background: rgba(107, 142, 35, 0.4); border: 2px solid rgba(85, 107, 47, 0.8);"></div>
                                    <span class="legend-label">אקליפטוס גומפוצפלה</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-symbol" style="background: rgba(143, 188, 143, 0.4); border: 2px solid rgba(107, 142, 107, 0.8);"></div>
                                    <span class="legend-label">אקליפטוס המקור</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-symbol" style="background: rgba(128, 128, 0, 0.4); border: 2px solid rgba(107, 107, 0, 0.8);"></div>
                                    <span class="legend-label">זיתים</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-symbol" style="background: rgba(85, 107, 47, 0.4); border: 2px solid rgba(62, 77, 36, 0.8);"></div>
                                    <span class="legend-label">חרובים</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-symbol" style="background: rgba(255, 192, 203, 0.4); border: 2px solid rgba(219, 112, 147, 0.8);"></div>
                                    <span class="legend-label">עצי פרי</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-symbol" style="background: rgba(154, 205, 50, 0.4); border: 2px solid rgba(107, 142, 35, 0.8);"></div>
                                    <span class="legend-label">חורש עד אציל - אלון חולע</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-symbol" style="background: rgba(173, 255, 47, 0.4); border: 2px solid rgba(124, 179, 66, 0.8);"></div>
                                    <span class="legend-label">עצי חורש ארץ ישראלי</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-symbol" style="background: rgba(189, 183, 107, 0.4); border: 2px solid rgba(139, 134, 78, 0.8);"></div>
                                    <span class="legend-label">חורש טבעי דליל</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-symbol" style="background: rgba(188, 143, 143, 0.4); border: 2px solid rgba(139, 90, 90, 0.8);"></div>
                                    <span class="legend-label">בני שיח עבותיים</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-symbol" style="background: rgba(192, 192, 192, 0.3); border: 2px solid rgba(128, 128, 128, 0.8);"></div>
                                    <span class="legend-label">אחר</span>
                                </div>
                            </div>
                            <div class="legend-section">
                                <h4>צפיפות אירועים</h4>
                                <div class="legend-item">
                                    <div class="legend-symbol" style="background: #e8fcd4; width: 20px; height: 20px; border-radius: 50%;"></div>
                                    <span class="legend-label">2 אירועים</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-symbol" style="background: #b7f293; width: 26px; height: 26px; border-radius: 50%;"></div>
                                    <span class="legend-label">10 אירועים</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-symbol" style="background: #74cf75; width: 34px; height: 34px; border-radius: 50%;"></div>
                                    <span class="legend-label">50 אירועים</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-symbol" style="background: #39a96b; width: 44px; height: 44px; border-radius: 50%;"></div>
                                    <span class="legend-label">200 אירועים</span>
                                </div>
                                <div class="legend-item">
                                    <div class="legend-symbol" style="background: #1f7c4c; width: 54px; height: 54px; border-radius: 50%;"></div>
                                    <span class="legend-label">1000+ אירועים</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
<div class="resize-divider">
  <div class="resize-stack">
    <button class="resize-button" title="Map full (>)" onclick="setLayout(1)">&gt;</button>
    <button class="resize-button" title="Split (&lt;&gt;)" onclick="setLayout(0)">&lt;&gt;</button>
    <button class="resize-button" title="Table full (&lt;)" onclick="setLayout(2)">&lt;</button>
  </div>
</div>
        
        <div class="table-section" id="tableSection">
            <div id="infoPanel" class="info-panel">
                <h3 id="infoPanelTitle">טיפולים ביער</h3>
                <div id="summaryInfo" class="summary-info"></div>
                <table class="info-table">
                    <thead>
                        <tr>
                            <th>עומד</th>
                            <th>חלקה</th>
                            <th>גוש</th>
                            <th>יער</th>
                            <th>שטח (דונם)</th>
                            <th>תאריך</th>
                            <th>אירוע</th>
                        </tr>
                    </thead>
                    <tbody id="infoTableBody">
                        <!-- Table rows will be populated here -->
                    </tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="time-slider-container">
        <div class="time-slider-label">סינון לפי תאריך:</div>
        <div id="timeSlider"></div>
        <div class="time-slider-dates" id="timeSliderDates"></div>
    </div>
    
    <div class="loading" id="loading">טוען נתונים...</div>
    <div class="error-message" id="errorMessage"></div>


    <script src="https://js.arcgis.com/4.28/"></script>



<script>
  function toggleLegend() {
    const c = document.getElementById('legendContent');
    const t = document.getElementById('legendToggle');
    c.classList.toggle('collapsed');
    t.classList.toggle('collapsed');
  }
  function scrollEvents(direction) {
    document.getElementById('eventTypesContainer').scrollLeft += 300 * direction;
  }

  require([
    "esri/Map",
    "esri/views/MapView",
    "esri/layers/FeatureLayer",
    "esri/widgets/Search",
    "esri/widgets/TimeSlider"
  ], function (Map, MapView, FeatureLayer, Search, TimeSlider) {

    // ---------- State ----------
    let featureLayer, featureForest;
    let activeEventType = null;   
    let eventTypeField = null;
    let FIELD = {};              
    let timeSlider = null;
    let currentTimeExtent = null;
    let highlightSelect = null;
    let forestLayerManuallyToggled = false;
    let lastExtentJSON = null;

    const map = new Map({ basemap: "satellite" });
    const view = new MapView({
      container: "mapView",
      map,
      center: [35.0818, 31.5],
      zoom: 8
    });

    function showError(msg) {
      const el = document.getElementById('errorMessage');
      if (!el) return;
      el.textContent = msg;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 5000);
    }

    function hasField(layer, name) {
      return !!layer.fields?.some(f => f.name === name);
    }
    function firstExisting(layer, names) {
      return names.find(n => hasField(layer, n)) || null;
    }
    function sqlString(v) {
      if (v == null) return "NULL";
      return "'" + String(v).replace(/'/g, "''") + "'";
    }
    function debounce(fn, ms = 200) {
      let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), ms); };
    }
    const debouncedApply = debounce(applyFilters, 200);

function formatDateShort(yearValue) {
  if (!yearValue) return '-';
  if (typeof yearValue === 'number' || !isNaN(yearValue)) {
    return yearValue.toString();
  }
  const d = new Date(yearValue);
  if (isNaN(d)) return '-';
  return d.getFullYear().toString();
}


function formatDateFull(date) {
  if (!date) return '';
  const d = new Date(date);
  return d.getFullYear().toString();
}
    function getActiveFilters() {
      return {
        DistrictName: document.getElementById('DistrictName')?.value || "",
        region: document.getElementById('region')?.value || "",
        forest: document.getElementById('forest')?.value || "",
        gush:   document.getElementById('gush')?.value || "",
        parcel: document.getElementById('parcel')?.value || "",
        stand:  document.getElementById('stand')?.value || ""
      };
    }

    const SIZE_STOPS = [
      { value: 2, size: 20 }, { value: 10, size: 26 }, { value: 50, size: 34 },
      { value: 200, size: 44 }, { value: 1000, size: 54 }
    ];
    const COLOR_STOPS = [
      { value: 2, color: "#e8fcd4" }, { value: 10, color: "#b7f293" },
      { value: 50, color: "#74cf75" }, { value: 200, color: "#39a96b" },
      { value: 1000, color: "#1f7c4c" }
    ];
    const clusterRenderer = {
      type: "simple",
      symbol: { type: "simple-marker", style: "circle", size: 20, color: "#e8fcd4", outline: { color: "#fff", width: 1 } },
      visualVariables: [
        { type: "size", field: "cluster_count", stops: SIZE_STOPS, legendOptions: { title: "כמות אירועים בקבוצה" } },
        { type: "color", field: "cluster_count", stops: COLOR_STOPS, legendOptions: { title: "עוצמת צפיפות" } }
      ]
    };

    featureLayer = new FeatureLayer({
      portalItem: { id: "ee2a901cd3d44e79bfb9bd718818f5ab" },
      layerId: 1,
      outFields: ["OBJECTID"],
      popupEnabled: true,
      featureReduction: {
        type: "cluster",
        clusterRadius: "80px",
        labelsVisible: true,
        labelingInfo: [{
          deconflictionStrategy: "none",
          labelPlacement: "center-center",
          labelExpressionInfo: { expression: "Text($feature.cluster_count, '#,###')" },
          symbol: {
            type: "text",
            color: "white",
            haloColor: "black",
            haloSize: 1.5,
            font: { family: "Arial Unicode MS", size: 12, weight: "bold" }
          }
        }],
        popupTemplate: {
          title: "קבוצה של {cluster_count} אירועים",
          content: "התקרב כדי לפרק את הקבוצה לאירועים בודדים."
        },
        renderer: clusterRenderer
      }
    });


    featureForest = new FeatureLayer({
      portalItem: { id: "ee2a901cd3d44e79bfb9bd718818f5ab" },
      layerId: 0,
      outFields: ["*"],
      definitionExpression: "UPDATE_CODE <> 'D' OR UPDATE_CODE IS NULL",
      labelsVisible: true,
      labelingInfo: [{
        symbol: {
          type: "text",
          color: [255,255,255,0.9],
          haloColor: [0,100,0,0.9],
          haloSize: 2,
          font: { family: "Arial Unicode MS", size: 12, weight: "bold" }
        }      }],
      renderer: {
        type: "unique-value",
        field: "COV_TYPE_NAME",
        defaultSymbol: { type: "simple-fill", color: [200,200,200,0.3], outline: { color: [100,100,100,0.6], width: 1 } },

uniqueValueInfos: [
                        {
                            value: "מעורב עצי מחט",
                            symbol: {
                                type: "simple-fill",
                                color: [0, 77, 0, 0.4],
                                outline: {
                                    color: [0, 51, 0, 0.8],
                                    width: 2
                                }
                            },
                            label: "מעורב עצי מחט"
                        },
                        {
                            value: "אורן ברוטיה",
                            symbol: {
                                type: "simple-fill",
                                color: [0, 102, 0, 0.4],
                                outline: {
                                    color: [0, 77, 0, 0.8],
                                    width: 2
                                }
                            },
                            label: "אורן ברוטיה"
                        },
                        {
                            value: "אורן ירושלים",
                            symbol: {
                                type: "simple-fill",
                                color: [0, 128, 0, 0.4],
                                outline: {
                                    color: [0, 102, 0, 0.8],
                                    width: 2
                                }
                            },
                            label: "אורן ירושלים"
                        },
                        {
                            value: "רחבי עלים",
                            symbol: {
                                type: "simple-fill",
                                color: [34, 139, 34, 0.4],
                                outline: {
                                    color: [0, 100, 0, 0.8],
                                    width: 2
                                }
                            },
                            label: "רחבי עלים"
                        },
                        {
                            value: "מעורב עצי מחט - רחבי עלים",
                            symbol: {
                                type: "simple-fill",
                                color: [60, 179, 113, 0.4],
                                outline: {
                                    color: [46, 125, 50, 0.8],
                                    width: 2
                                }
                            },
                            label: "מעורב עצי מחט - רחבי עלים"
                        },
                        {
                            value: "ברוש מצוי",
                            symbol: {
                                type: "simple-fill",
                                color: [46, 125, 50, 0.4],
                                outline: {
                                    color: [27, 94, 32, 0.8],
                                    width: 2
                                }
                            },
                            label: "ברוש מצוי"
                        },
                        {
                            value: "אקליפטוס גומפוצפלה",
                            symbol: {
                                type: "simple-fill",
                                color: [107, 142, 35, 0.4],
                                outline: {
                                    color: [85, 107, 47, 0.8],
                                    width: 2
                                }
                            },
                            label: "אקליפטוס גומפוצפלה"
                        },
                        {
                            value: "זיתים",
                            symbol: {
                                type: "simple-fill",
                                color: [128, 128, 0, 0.4],
                                outline: {
                                    color: [107, 107, 0, 0.8],
                                    width: 2
                                }
                            },
                            label: "זיתים"
                        },
                        {
                            value: "חרובים",
                            symbol: {
                                type: "simple-fill",
                                color: [85, 107, 47, 0.4],
                                outline: {
                                    color: [62, 77, 36, 0.8],
                                    width: 2
                                }
                            },
                            label: "חרובים"
                        },
                        {
                            value: "אורן גלעין",
                            symbol: {
                                type: "simple-fill",
                                color: [0, 153, 0, 0.4],
                                outline: {
                                    color: [0, 128, 0, 0.8],
                                    width: 2
                                }
                            },
                            label: "אורן גלעין"
                        },
                        {
                            value: "מעורב רחבי עלים",
                            symbol: {
                                type: "simple-fill",
                                color: [144, 238, 144, 0.4],
                                outline: {
                                    color: [0, 128, 0, 0.8],
                                    width: 2
                                }
                            },
                            label: "מעורב רחבי עלים"
                        },
                        {
                            value: "עצי פרי",
                            symbol: {
                                type: "simple-fill",
                                color: [255, 192, 203, 0.4],
                                outline: {
                                    color: [219, 112, 147, 0.8],
                                    width: 2
                                }
                            },
                            label: "עצי פרי"
                        },
                        {
                            value: "חורש עד אציל - אלון חולע",
                            symbol: {
                                type: "simple-fill",
                                color: [154, 205, 50, 0.4],
                                outline: {
                                    color: [107, 142, 35, 0.8],
                                    width: 2
                                }
                            },
                            label: "חורש עד אציל - אלון חולע"
                        },
                        {
                            value: "עצי חורש ארץ ישראלי",
                            symbol: {
                                type: "simple-fill",
                                color: [173, 255, 47, 0.4],
                                outline: {
                                    color: [124, 179, 66, 0.8],
                                    width: 2
                                }
                            },
                            label: "עצי חורש ארץ ישראלי"
                        },
                        {
                            value: "חורש טבעי דליל",
                            symbol: {
                                type: "simple-fill",
                                color: [189, 183, 107, 0.4],
                                outline: {
                                    color: [139, 134, 78, 0.8],
                                    width: 2
                                }
                            },
                            label: "חורש טבעי דליל"
                        },
                        {
                            value: "בני שיח עבותיים",
                            symbol: {
                                type: "simple-fill",
                                color: [188, 143, 143, 0.4],
                                outline: {
                                    color: [139, 90, 90, 0.8],
                                    width: 2
                                }
                            },
                            label: "בני שיח עבותיים"
                        },
                        {
                            value: "אקליפטוס המקור",
                            symbol: {
                                type: "simple-fill",
                                color: [143, 188, 143, 0.4],
                                outline: {
                                    color: [107, 142, 107, 0.8],
                                    width: 2
                                }
                            },
                            label: "אקליפטוס המקור"
                        },
                        {
                            value: "Other",
                            symbol: {
                                type: "simple-fill",
                                color: [192, 192, 192, 0.3],
                                outline: {
                                    color: [128, 128, 128, 0.8],
                                    width: 2
                                }
                            },
                            label: "Other"
                        }
                    ]
      },
      popupTemplate: {
        title: "{ForestName}",
        content: function (feature) {
          const a = feature.graphic.attributes;
          const area = (a.NET_AREA ? Number(a.NET_AREA).toFixed(1)
                                   : (a.AREA ? Number(a.AREA).toFixed(1)
                                             : (a.Shape_Area ? (Number(a.Shape_Area)/1000).toFixed(1) : "-")));
          return "יער: " + (a.ForestName ?? "-")
            + "<br>גוש: " + (a.ForestGushName ?? "-")
            + "<br>חלקה: " + (a.HELKA ?? "-")
            + "<br>עומד: " + (a.STAND_NO ?? "-")
            + "<br>סוג כיסוי: " + (a.COV_TYPE_NAME ?? "-")
            + "<br>שטח: " + area + " דונם"
            + "<br>אזור: " + (a.RegionName ?? a.REGION ?? "-");
        }
      }
    });

    map.addMany([featureForest, featureLayer]);

    document.getElementById('forestLayerToggle')?.addEventListener('change', (e) => {
    forestLayerManuallyToggled = true;
    featureForest.visible = e.target.checked;
    });
    document.getElementById('eventsLayerToggle')?.addEventListener('change', (e) => {
      featureLayer.visible = e.target.checked;
    });



let layoutState = 0; // 0 = split (2/3 map, 1/3 table), 1 = map only, 2 = table only

window.setLayout = function (state) {
  layoutState = state;

  const mapSection   = document.getElementById('mapSection');
  const tableSection = document.getElementById('tableSection');

  if (!mapSection || !tableSection) return;

  // reset classes
  mapSection.classList.remove('collapsed', 'expanded');
  tableSection.classList.remove('collapsed', 'expanded');

  if (state === 0) {
    // Split view — keep your default flex: map(2) / table(1)
  } else if (state === 1) {
    // Map only
    mapSection.classList.add('expanded');
    tableSection.classList.add('collapsed');
  } else if (state === 2) {
    // Table only
    mapSection.classList.add('collapsed');
    tableSection.classList.add('expanded');
  }

  // Make ArcGIS view recalc after layout change
  try {
    view.resize();
    setTimeout(() => view.resize(), 0);
  } catch (e) { /* no-op */ }
};

window.addEventListener('DOMContentLoaded', () => {
  const btnExpandMap   = document.getElementById('btnExpandMap');
  const btnBoth        = document.getElementById('btnBoth');
  const btnExpandTable = document.getElementById('btnExpandTable');

  if (btnExpandMap)   btnExpandMap.onclick   = () => setLayout(1);
  if (btnBoth)        btnBoth.onclick        = () => setLayout(0);
  if (btnExpandTable) btnExpandTable.onclick = () => setLayout(2);
});


let minYearGlobal = null;
let maxYearGlobal = null;
    
function populateYearSelects(minYear, maxYear) {
  const fromSel = document.getElementById('yearFrom');
  const toSel   = document.getElementById('yearTo');
  if (!fromSel || !toSel) return;

  // ניקה אפשרויות קודמות (מלבד ברירת מחדל)
  while (fromSel.options.length > 1) fromSel.remove(1);
  while (toSel.options.length   > 1) toSel.remove(1);

  for (let y = minYear; y <= maxYear; y++) {
    const opt1 = document.createElement('option');
    opt1.value = String(y);
    opt1.textContent = String(y);
    fromSel.appendChild(opt1);

    const opt2 = document.createElement('option');
    opt2.value = String(y);
    opt2.textContent = String(y);
    toSel.appendChild(opt2);
  }
}

function getYearRangeFromSelects() {
  const fromSel = document.getElementById('yearFrom');
  const toSel   = document.getElementById('yearTo');
  if (!fromSel || !toSel || !FIELD.year) return null;

  const fromVal = fromSel.value ? Number(fromSel.value) : (minYearGlobal ?? null);
  const toVal   = toSel.value   ? Number(toSel.value)   : (maxYearGlobal ?? null);

  if (fromVal == null || toVal == null) return null;
  // הבטח סדר נכון
  const startY = Math.min(fromVal, toVal);
  const endY   = Math.max(fromVal, toVal);
  return { startY, endY };
}

function onYearSelectChange() {
  const yr = getYearRangeFromSelects();
  if (!yr) return;

  // עדכן גם את ה־TimeSlider
  if (timeSlider) {
    const start = new Date(yr.startY, 0, 1);
    const end   = new Date(yr.endY, 11, 31);
    currentTimeExtent = { start, end };
    timeSlider.timeExtent = currentTimeExtent;
    const datesEl = document.getElementById('timeSliderDates');
    if (datesEl) datesEl.textContent = `${yr.startY} - ${yr.endY}`;
  }

  applyFilters({ skipExtent: false });
}




function resolveFieldsAfterLoad() {
  eventTypeField = (function pickEventTypeField(layer) {
    const candidates = ["EventType","EVENTTYPE","EVENT_TYPE","ActivityType","WorkType","TYPE"];
    for (const c of candidates) if (hasField(layer, c)) return c;
    const lower = layer.fields?.find(f => f.type === "string" && f.name.toLowerCase().includes("type"));
    return lower?.name || null;
  })(featureLayer);

  FIELD = {
    DistrictName: firstExisting(featureLayer, ["DistrictName","DistrictName"]),
    forest: firstExisting(featureLayer, ["ForestName","ForestName"]),
    gush:   firstExisting(featureLayer, ["ForestGushName","GUSH"]),
    parcel: firstExisting(featureLayer, ["HELKA","Parcel"]),
    stand:  firstExisting(featureLayer, ["STAND_NO","StandNo"]),
    area:   firstExisting(featureLayer, ["NET_AREA","AREA","Shape_Area"]),
    year:   firstExisting(featureLayer, ["year","Year","YEAR"]), // Single year field
    type:   eventTypeField
  };
  
}


const FILTER_ORDER = [
  { id: "DistrictName", fieldKey: "DistrictName" }, // מרחב
  { id: "region",       fieldKey: "region"       }, // אזור
  { id: "forest",       fieldKey: "forest"       }, // יער
  { id: "gush",         fieldKey: "gush"         }, // גוש
  { id: "parcel",       fieldKey: "parcel"       }, // חלקה
  { id: "stand",        fieldKey: "stand"        }  // עומד
];

// Build a WHERE that includes: active event-type, year range/time slider,
// and only the filters ABOVE a given index (so each dropdown reflects higher choices).
function buildWhereForCascading(uptoIndexExclusive) {
  const parts = ["1=1"];

  // Event type card
  if (activeEventType?.field && activeEventType?.value) {
    parts.push(`${activeEventType.field} = ${sqlString(activeEventType.value)}`);
  }

  // Year range / time slider
  if (FIELD.year) {
    const yr = getYearRangeFromSelects();
    if (yr) {
      parts.push(`(${FIELD.year} >= ${yr.startY} AND ${FIELD.year} <= ${yr.endY})`);
    } else if (currentTimeExtent) {
      const sy = currentTimeExtent.start.getFullYear();
      const ey = currentTimeExtent.end.getFullYear();
      parts.push(`(${FIELD.year} >= ${sy} AND ${FIELD.year} <= ${ey})`);
    }
  }

  const filters = getActiveFilters();
  for (let i = 0; i < Math.min(uptoIndexExclusive, FILTER_ORDER.length); i++) {
    const { id, fieldKey } = FILTER_ORDER[i];
    const fName = FIELD[fieldKey];
    const val   = filters[id];
    if (fName && val) parts.push(`${fName} = ${sqlString(val)}`);
  }
  return parts.join(" AND ");
}

// Query distinct values for one field, under a given WHERE
async function queryDistinctValues(fieldName, where) {
  if (!fieldName) return [];
  const q = await featureLayer.queryFeatures({
    where,
    outFields: [fieldName],
    returnGeometry: false,
    returnDistinctValues: true,
    orderByFields: [fieldName]
  });
  return (q.features || [])
    .map(f => f.attributes[fieldName])
    .filter(v => v != null && v !== "" && v !== "null" && v !== "undefined");
}

// Replace options in a <select>, keep the first "הכל", try to preserve selection if still valid
function setSelectOptions(selectId, values) {
  const sel = document.getElementById(selectId);
  if (!sel) return;
  const old = sel.value || "";
  // clear (keep index 0 = "הכל")
  while (sel.options.length > 1) sel.remove(1);
  values.forEach(v => {
    const opt = document.createElement('option');
    opt.value = v; opt.textContent = v;
    sel.appendChild(opt);
  });
  // keep previous selection if still available, else reset to ""
  if (old && values.includes(old)) sel.value = old; else sel.value = "";
}

// Rebuild the dropdowns from a starting index downward (start changed → update below)
async function rebuildCascadingFrom(startIndex = 0) {
  for (let i = startIndex; i < FILTER_ORDER.length; i++) {
    const { id, fieldKey } = FILTER_ORDER[i];
    const where = buildWhereForCascading(i); // only filters above i, plus type/year
    const values = await queryDistinctValues(FIELD[fieldKey], where);
    setSelectOptions(id, values);
  }
}

// When a higher filter changes, clear the ones below (UI) and rebuild them
function clearBelow(startIndex) {
  for (let i = startIndex + 1; i < FILTER_ORDER.length; i++) {
    const sel = document.getElementById(FILTER_ORDER[i].id);
    if (sel) sel.value = "";
  }
}

// Hook change events for cascading behavior
FILTER_ORDER.forEach(({ id }, idx) => {
  const el = document.getElementById(id);
  if (!el) return;
  el.addEventListener('change', async () => {
    forestLayerManuallyToggled = false;
    clearBelow(idx);
    await rebuildCascadingFrom(idx + 1);
    debouncedApply(); // refresh layer/table with full WHERE (all chosen filters)
  });
});

// Rebuild all filters (used on boot and when year/type changes)
async function rebuildAllFilters() {
  // First, (re)build top-level using only type/year
  await rebuildCascadingFrom(0);
}

// Replace your old populateFiltersServer with this:
async function populateFiltersServer() {
  // Ensure field mapping for region exists
  FIELD.region = firstExisting(featureLayer, ["RegionName","REGION"]);
  // Initial population based on *current* event-type + year (if any), no other filters
  await rebuildAllFilters();
}

// Update cascading choices when event-type card or year range changes:
const _origUpdateEventTypeCountsServer = updateEventTypeCountsServer;
updateEventTypeCountsServer = async function(baseWhere) {
  await _origUpdateEventTypeCountsServer(baseWhere);
  // If event type changed counts, also refresh the cascades so numbers reflect it
  await rebuildAllFilters();
};

const _origOnYearSelectChange = onYearSelectChange;
onYearSelectChange = function() {
  _origOnYearSelectChange();
  rebuildAllFilters();
};

// Also watch the TimeSlider (already calls applyFilters). Add a light cascade refresh:
const _origInitializeTimeSlider = initializeTimeSlider;
initializeTimeSlider = async function() {
  await _origInitializeTimeSlider();
  if (timeSlider) {
    timeSlider.watch("timeExtent", debounce(async () => {
      await rebuildAllFilters();
    }, 250));
  }
};


function sqlEscape(v){ return String(v).replace(/'/g,"''"); }
function sqlList(values){
  return values.map(v => `'${sqlEscape(v)}'`).join(",");
}

function buildWhere() {
  const f = getActiveFilters();
  const parts = ["1=1"];

  if (activeEventType?.field && activeEventType?.value) {
    parts.push(`${activeEventType.field} = ${sqlString(activeEventType.value)}`);
  }

  console.log("Active filters:", f);

  if (FIELD.DistrictName && f.DistrictName) parts.push(`${FIELD.DistrictName} = ${sqlString(f.DistrictName)}`);
  if (FIELD.region && f.region) parts.push(`${FIELD.region} = ${sqlString(f.region)}`);
  if (FIELD.forest && f.forest) parts.push(`${FIELD.forest} = ${sqlString(f.forest)}`);
  if (FIELD.gush   && f.gush)   parts.push(`${FIELD.gush}   = ${sqlString(f.gush)}`);
  if (FIELD.parcel && f.parcel) parts.push(`${FIELD.parcel} = ${sqlString(f.parcel)}`);
  if (FIELD.stand  && f.stand)  parts.push(`${FIELD.stand}  = ${sqlString(f.stand)}`);

if (FIELD.year) {
  const yr = getYearRangeFromSelects();
  if (yr) {
    parts.push(`(${FIELD.year} >= ${yr.startY} AND ${FIELD.year} <= ${yr.endY})`);
  } else if (currentTimeExtent) {
    const startYear = currentTimeExtent.start.getFullYear();
    const endYear   = currentTimeExtent.end.getFullYear();
    parts.push(`(${FIELD.year} >= ${startYear} AND ${FIELD.year} <= ${endYear})`);
  }
}

  return parts.join(" AND ");
}


async function refreshForestVisibility(where) {
  const baseForestExpr = "UPDATE_CODE_NAME <> 'נמחק' OR UPDATE_CODE_NAME IS NULL";
  const chk = document.getElementById('forestLayerToggle');

  // If the points layer has no forest field, just hide the polygon layer.
  // if (!FIELD.forest) {
  //   featureForest.visible = false;
  //   if (chk) chk.checked = false;
  //   featureForest.definitionExpression = baseForestExpr;
  //   return;
  // }

  // Get distinct forest names from the filtered points
  const res = await featureLayer.queryFeatures({
    where,
    outFields: [FIELD.forest],
    returnGeometry: false,
    returnDistinctValues: true,
    orderByFields: [FIELD.forest]
  });

  const names = (res.features || [])
    .map(f => f.attributes[FIELD.forest])
    .filter(v => v != null && v !== "" && v !== "null" && v !== "undefined");

}


async function applyFilters(opts = {}) {



  const yFrom = document.getElementById('yearFrom');
  const yTo   = document.getElementById('yearTo');
  if (yFrom) yFrom.addEventListener('change', onYearSelectChange);
  if (yTo)   yTo.addEventListener('change',   onYearSelectChange);


  const { skipExtent = false } = opts;
  const where = buildWhere();

  featureLayer.definitionExpression = where;


  if (!skipExtent) {
    try {
      const ext = await featureLayer.queryExtent({ where });
      if (ext.count > 0 && ext.extent) {
        const newJSON = JSON.stringify(ext.extent.toJSON());
        if (newJSON !== lastExtentJSON) {
          lastExtentJSON = newJSON;
          await view.goTo(ext.extent.expand(1.05), { animate: false });
        }
      }
    } catch (e) {
      console.warn("queryExtent failed", e);
    }
  }

  const outFields = ["OBJECTID",FIELD.DistrictName, FIELD.region, FIELD.forest, FIELD.gush, FIELD.parcel, FIELD.stand, FIELD.area, FIELD.year, FIELD.type]
    .filter(Boolean);
  const result = await featureLayer.queryFeatures({ where, returnGeometry: false, outFields });

  updateInfoTable(result.features, FIELD);
  updateSummary(result.features, FIELD);

  const panel = document.getElementById('infoPanel');
  if (panel) panel.style.display = result.features.length ? 'block' : 'none';

  await updateEventTypeCountsServer(where);
}




async function initializeEventTypes() {
  if (!FIELD.type) {
    const ctr = document.getElementById('eventTypesContainer');
    if (ctr) ctr.innerHTML = '<div style="padding: 20px; color:#ccc;">אין שדה סוג אירוע</div>';
    return;
  }

  const stats = await featureLayer.queryFeatures({
    where: "1=1",
    returnGeometry: false,
    groupByFieldsForStatistics: [FIELD.type],
    outStatistics: [{ statisticType: "count", onStatisticField: "1", outStatisticFieldName: "cnt" }]
  });

  const container = document.getElementById('eventTypesContainer');
  if (!container) return;
  container.innerHTML = '';

  const rows = (stats.features || [])
    .map(f => ({ name: String(f.attributes[FIELD.type]), value: f.attributes[FIELD.type], count: f.attributes.cnt }))
    .filter(e => e.value != null && e.name !== "null" && e.name !== "undefined");

  const total = rows.reduce((s, r) => s + (r.count || 0), 0);

  const allCard = document.createElement('div');
  allCard.className = 'event-type-card';
  allCard.style.background = '#2d6a4f';
  allCard.innerHTML = `<div class="event-count">${total}</div><div class="event-type-name">הכל</div>`;
  allCard.onclick = () => {
    document.querySelectorAll('.event-type-card').forEach(c => c.classList.remove('active'));
    allCard.classList.add('active');
    activeEventType = null;
    const t = document.getElementById('infoPanelTitle'); if (t) t.textContent = 'כל הפעילויות';
    const panel = document.getElementById('infoPanel');  if (panel) panel.style.display = 'block';
    applyFilters();
  };
  container.appendChild(allCard);

  rows.forEach(et => {
    const card = document.createElement('div');
    card.className = 'event-type-card';
    card.innerHTML = `<div class="event-count">${et.count}</div><div class="event-type-name">${et.name}</div>`;
    card.onclick = () => {
      const isActive = card.classList.contains('active');
      document.querySelectorAll('.event-type-card').forEach(c => c.classList.remove('active'));
      if (isActive) {
        allCard.classList.add('active'); activeEventType = null;
        const t = document.getElementById('infoPanelTitle'); if (t) t.textContent = 'כל הפעילויות';
      } else {
        card.classList.add('active');
        activeEventType = { field: FIELD.type, value: et.value, name: et.name };
        const t = document.getElementById('infoPanelTitle'); if (t) t.textContent = `${et.name} - סיכום פעילות`;
      }
      const panel = document.getElementById('infoPanel');  if (panel) panel.style.display = 'block';
      applyFilters();
    };
    container.appendChild(card);
  });

  allCard.classList.add('active');
}

async function updateEventTypeCountsServer(baseWhere) {
  if (!FIELD.type) return;

  let stats;
  try {
    stats = await featureLayer.queryFeatures({
      where: baseWhere,
      returnGeometry: false,
      groupByFieldsForStatistics: [FIELD.type],
      outStatistics: [{ statisticType: "count", onStatisticField: "1", outStatisticFieldName: "cnt" }]
    });
  } catch (e) {
    console.warn("updateEventTypeCountsServer stats query failed", e);
    return;
  }

  const features = Array.isArray(stats.features) ? stats.features : [];

  const counts = Object.create(null);
  let total = 0;
  for (const f of features) {
    const val = f?.attributes?.[FIELD.type];
    const cnt = Number(f?.attributes?.cnt) || 0;
    if (val != null) {
      counts[String(val)] = (counts[String(val)] || 0) + cnt;
      total += cnt;
    }
  }

  const cards = document.querySelectorAll('.event-type-card');

  if (cards[0]) {
    const allCountEl = cards[0].querySelector('.event-count');
    if (allCountEl) allCountEl.textContent = String(total);
  }

  for (let i = 1; i < cards.length; i++) {
    const name = cards[i].querySelector('.event-type-name')?.textContent ?? "";
    const count = counts[name] || 0;
    const el = cards[i].querySelector('.event-count');
    if (el) el.textContent = String(count);
  }
}


async function initializeTimeSlider() {
  if (!FIELD.year) {
    const c = document.querySelector('.time-slider-container');
    if (c) c.style.display = 'none';
    return;
  }

  const outStats = [
    { statisticType: "min", onStatisticField: FIELD.year, outStatisticFieldName: "minYear" },
    { statisticType: "max", onStatisticField: FIELD.year, outStatisticFieldName: "maxYear" }
  ];

  let minDate = null, maxDate = null;
  try {
    const res = await featureLayer.queryFeatures({ 
      where: "1=1", 
      returnGeometry: false, 
      outStatistics: outStats 
    });
    const a = res.features?.[0]?.attributes || {};
    minYearGlobal = a.minYear ?? null;
    maxYearGlobal = a.maxYear ?? null;

    if (minYearGlobal && maxYearGlobal) {
      // מלא את הרשימות העליונות
      populateYearSelects(minYearGlobal, maxYearGlobal);

      minDate = new Date(minYearGlobal, 0, 1);
      maxDate = new Date(maxYearGlobal, 11, 31);
    }
  } catch (e) {
    console.warn("year stats failed", e);
  }

  if (!minDate || !maxDate || isNaN(minDate) || isNaN(maxDate)) {
    const c = document.querySelector('.time-slider-container');
    if (c) c.style.display = 'none';
    return;
  }

  timeSlider = new TimeSlider({
    container: "timeSlider",
    view,
    mode: "time-window",
    timeVisible: false,
    labelFormatFunction: (value, type, element) => {
      const d = value instanceof Date ? value : new Date(value);
      if (isNaN(d)) { 
        element.textContent = ""; 
        return; 
      }
      element.textContent = d.getFullYear().toString();
    },
    fullTimeExtent: { start: minDate, end: maxDate },
    stops: { interval: { value: 1, unit: "years" } }, 
    playRate: 2000
  });

  timeSlider.timeExtent = { start: minDate, end: maxDate };
  const datesEl = document.getElementById('timeSliderDates');
  if (datesEl) {
    datesEl.textContent = `${minDate.getFullYear()} - ${maxDate.getFullYear()}`;
  }

timeSlider.watch("timeExtent", (value) => {
  currentTimeExtent = value;
  const datesEl = document.getElementById('timeSliderDates');
  if (datesEl) {
    datesEl.textContent = `${value.start.getFullYear()} - ${value.end.getFullYear()}`;
  }

  const yFrom = document.getElementById('yearFrom');
  const yTo   = document.getElementById('yearTo');
  if (yFrom && yTo) {
    const sy = value.start.getFullYear();
    const ey = value.end.getFullYear();
    yFrom.value = (minYearGlobal != null && sy === Number(minYearGlobal)) ? "" : String(sy);
    yTo.value   = (maxYearGlobal != null && ey === Number(maxYearGlobal)) ? "" : String(ey);
  }

  applyFilters({ skipExtent: true });
})};



    function toEsriTimestampLiteral(ms) {
  const d = new Date(ms);
  const Y = d.getUTCFullYear();
  const M = '1'
  const D = '1'
  const hh = '1'
  const mm = '1'
  const ss = '1'
  return `TIMESTAMP '${Y}-${M}-${D} ${hh}:${mm}:${ss}'`;
}




function updateInfoTable(features, FIELD) {
  const tbody = document.getElementById('infoTableBody');
  if (!tbody) return;
  tbody.innerHTML = '';

  if (!features.length) {
    tbody.innerHTML = '<tr><td colspan="7" style="text-align:center;">אין נתונים להצגה</td></tr>';
    return;
  }

  features.forEach(f => {
    const a = f.attributes;
    const tr = document.createElement('tr');
    tr.className = 'clickable-row';
    tr.setAttribute('data-oid', a.OBJECTID);

    const stand  = FIELD.stand  ? (a[FIELD.stand]  ?? '-') : '-';
    const parcel = FIELD.parcel ? (a[FIELD.parcel] ?? '-') : '-';
    const gush   = FIELD.gush   ? (a[FIELD.gush]   ?? '-') : '-';
    const forest = FIELD.forest ? (a[FIELD.forest] ?? '-') : '-';
    let area = '-';
    if (FIELD.area) {
      const v = Number(a[FIELD.area]); 
      area = isFinite(v) ? v.toFixed(1) : '-';
    }

    const year = FIELD.year ? formatDateShort(a[FIELD.year]) : '-';
    const et = FIELD.type ? (a[FIELD.type] ?? '-') : '-';

    tr.innerHTML = `
      <td class="highlight-number">${stand}</td>
      <td>${parcel}</td>
      <td>${gush}</td>
      <td>${forest}</td>
      <td>${area}</td>
      <td>${year}</td>
      <td>${et}</td>
    `;

    tr.onclick = () => {
      const panel = document.getElementById('infoPanel');
      if (panel) panel.style.display = 'block';
      zoomToFeatureById(a.OBJECTID);
    };

    tbody.appendChild(tr);
  });
}


    function updateSummary(features, FIELD) {
      const el = document.getElementById('summaryInfo');
      if (!el) return;
      if (!features.length) { el.innerHTML = ''; return; }

      let totalArea = 0;
      const uniqForests = new Set();
      const uniqParcels = new Set();

      features.forEach(f => {
        const a = f.attributes;
        if (FIELD.area) {
          const v = Number(a[FIELD.area]);
          if (isFinite(v)) totalArea += v;
        }
        if (FIELD.forest && a[FIELD.forest]) uniqForests.add(a[FIELD.forest]);
        if (FIELD.parcel && a[FIELD.parcel]) uniqParcels.add(a[FIELD.parcel]);
      });

      el.innerHTML = `
        <strong>סה"כ רשומות:</strong> ${features.length} |
        <strong>שטח כולל:</strong> ${totalArea.toFixed(1)} דונם |
        <strong>יערות:</strong> ${uniqForests.size} |
        <strong>חלקות:</strong> ${uniqParcels.size}
      `;
    }

    async function zoomToFeatureById(objectId) {
      try {
        const r = await featureLayer.queryFeatures({
          where: `OBJECTID = ${objectId}`,
          returnGeometry: true,
          outFields: ["OBJECTID"]
        });
        if (!r.features.length) return;
        const feat = r.features[0];
        await view.goTo(feat.geometry, { animate: true, zoom: 16 });
        const lv = await view.whenLayerView(featureLayer);
        if (highlightSelect) highlightSelect.remove();
        highlightSelect = lv.highlight(feat);
      } catch (e) { console.warn("zoomToFeatureById failed", e); }
    }

    let searchWidget; 

    ['DistrictName','region','forest','gush','parcel','stand'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('change', () => { forestLayerManuallyToggled = false; debouncedApply(); });
    });

    (async function boot() {
      try {
        await featureLayer.load();
        resolveFieldsAfterLoad();

        const searchFields = [FIELD.forest, FIELD.parcel, FIELD.stand].filter(Boolean);
        searchWidget = new Search({
          view,
          sources: [{
            layer: featureLayer,
            searchFields,
            displayField: FIELD.forest || "OBJECTID",
            exactMatch: false,
            outFields: ["*"],
            name: "חיפוש יערות",
            placeholder: "חפש יער, חלקה או עומד"
          }],
          includeDefaultSources: false
        });
        view.ui.add(searchWidget, { position: "top-left", index: 0 });

        await view.goTo(featureLayer.fullExtent);

        await populateFiltersServer();
        await initializeEventTypes();
        await initializeTimeSlider();
        await applyFilters();
      } catch (e) {
        console.error(e);
        showError("שגיאה בטעינת הנתונים");
      } finally {
        const loading = document.getElementById('loading');
        if (loading) loading.style.display = 'none';
      }
    })();

  });
</script>
